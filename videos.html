<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Videos</title>

<style>
body { margin:0; font-family: Arial,sans-serif; background:#f0f8ff; }

header {
    background:#0B3D91;
    color:white;
    padding:15px 20px;
    display:flex;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
}
header h1 {
    margin:0;
    font-size:1.5em;
    flex-grow:1;
    text-align:center;
}
.back-symbol {
    font-size:1.4em;
    cursor:pointer;
    margin-right:10px;
    user-select:none;
}

.container {
    max-width:800px;
    margin:20px auto;
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:16px;
}

.button {
    display:flex;
    align-items:center;
    justify-content:center;
    background:white;
    color:#0B3D91;
    padding:20px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-size:16px;
    font-weight:bold;
    text-align:center;
    box-shadow:0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.2s, background 0.2s;
}
.button:hover {
    transform:translateY(-3px);
    background:#e6f2ff;
}

.file-card {
    display:flex;
    align-items:center;
    background:white;
    color:#0B3D91;
    padding:15px 20px;
    margin:6px 0;
    border-radius:12px;
    cursor:pointer;
    font-size:16px;
    font-weight:bold;
    box-shadow:0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.2s, background 0.2s;
    grid-column:1 / -1;
}
.file-card:hover {
    transform:translateY(-2px);
    background:#e6f2ff;
}

#previewContainer {
    width:100%;
    height:100vh;
    position:fixed;
    top:0;
    left:0;
    background:white;
    display:none;
    z-index:1000;
}
#previewContainer iframe {
    width:100%;
    height:100%;
    border:none;
}
#closePreview {
    position:absolute;
    top:10px;
    right:10px;
    background:#f44336;
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    z-index:1001;
}
#closePreview:hover {
    background:#d32f2f;
}
</style>
</head>

<body>

<header>
    <span id="backBtn" class="back-symbol" style="display:none;">←</span>
    <h1>Fincep Videos</h1>
</header>

<div class="container" id="content"></div>

<div id="previewContainer">
    <button id="closePreview">Close ✖</button>
    <iframe id="previewIframe" allowfullscreen></iframe>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCvL_D8wRVC3hS0mEvTt2J_D-LG7wFFpx0",
  authDomain: "environmentalgpt-4974a.firebaseapp.com",
  projectId: "environmentalgpt-4974a",
  storageBucket: "environmentalgpt-4974a.firebasestorage.app",
  messagingSenderId: "947094029861",
  appId: "1:947094029861:web:ffa5c1ad4abff06d6e21cc",
  measurementId: "G-36T3Y37DS4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- Predefined subjects ---
const subjectsList = ["BI210","CHEMISTRY","PHYSICS","MATHEMATICS","ENGLISH","GEOGRAPHY"];

let selectedSubject = null;
let selectedGrade = null;
let selectedMainTopic = null;

const content = document.getElementById("content");
const backBtn = document.getElementById("backBtn");
const previewContainer = document.getElementById("previewContainer");
const previewIframe = document.getElementById("previewIframe");
const closePreview = document.getElementById("closePreview");

closePreview.onclick = () => {
    previewContainer.style.display = "none";
    previewIframe.src = "";
};

backBtn.onclick = () => {
    if(selectedMainTopic){
        selectedMainTopic = null;
        loadVideos();
    } else if(selectedGrade){
        selectedGrade = null;
        loadVideos();
    } else {
        selectedSubject = null;
        loadSubjects();
    }
};

// ---- SUBJECTS ----
function loadSubjects(){
    content.innerHTML = "";
    backBtn.style.display = "none";

    subjectsList.forEach(subject=>{
        const btn = document.createElement("button");
        btn.className = "button";
        btn.textContent = subject;
        btn.onclick = () => {
            selectedSubject = subject;
            loadVideos();
        };
        content.appendChild(btn);
    });
}

// ---- VIDEOS ----
function loadVideos(){
    content.innerHTML = "";
    backBtn.style.display = "inline-block";

    db.collection("videos")
      .where("subject","==",selectedSubject)
      .get()
      .then(snapshot=>{
        // If no videos uploaded yet
        if(snapshot.empty && selectedSubject){
            content.innerHTML = "<p>No videos uploaded for this subject yet.</p>";
            return;
        }

        if(selectedSubject === "BIOLOGY"){
            const grades = [...new Set(snapshot.docs.map(d => d.data().grade))].filter(g=>g).sort();
            if(!selectedGrade){
                grades.forEach(grade=>{
                    const btn = document.createElement("button");
                    btn.className = "button";
                    btn.textContent = "Grade " + grade;
                    btn.onclick = () => { selectedGrade = grade; loadVideos(); };
                    content.appendChild(btn);
                });
                const allBtn = document.createElement("button");
                allBtn.className = "button";
                allBtn.textContent = "All Grades";
                allBtn.onclick = () => { selectedGrade = ""; loadVideos(); };
                content.appendChild(allBtn);
                return;
            }

            const mainTopics = [...new Set(snapshot.docs
                .filter(d=>selectedGrade==="" || d.data().grade==selectedGrade)
                .map(d => d.data().mainTopic || ""))].filter(t=>t).sort();

            if(!selectedMainTopic && mainTopics.length>0){
                mainTopics.forEach(topic=>{
                    const btn = document.createElement("button");
                    btn.className = "button";
                    btn.textContent = topic;
                    btn.onclick = () => { selectedMainTopic = topic; loadVideos(); };
                    content.appendChild(btn);
                });
                const allBtn = document.createElement("button");
                allBtn.className = "button";
                allBtn.textContent = "All Topics";
                allBtn.onclick = () => { selectedMainTopic = ""; loadVideos(); };
                content.appendChild(allBtn);
                return;
            }

            // Show videos
            let videos = snapshot.docs
                .filter(d=>{
                    const data = d.data();
                    const gradeMatch = selectedGrade === "" || data.grade == selectedGrade;
                    const topicMatch = selectedMainTopic === null || selectedMainTopic === "" || data.mainTopic == selectedMainTopic;
                    return gradeMatch && topicMatch;
                })
                .map(doc=>{
                    const data = doc.data();
                    return { id: doc.id, title: data.title, link: data.link, order: data.order || 999 };
                });

            videos.sort((a,b)=>a.order - b.order);

            if(videos.length === 0){
                content.innerHTML = "<p>No videos found for this selection</p>";
                return;
            }

            videos.forEach(video=>{
                const card = document.createElement("div");
                card.className = "file-card";
                card.textContent = `${video.order !== 999 ? video.order + ". " : ""}${video.title}`;
                card.onclick = () => openVideo(video.link);
                content.appendChild(card);
            });

        } else {
            // Other subjects
            const mainTopics = [...new Set(snapshot.docs.map(d=>d.data().mainTopic || ""))].filter(t=>t).sort();

            if(!selectedMainTopic && mainTopics.length>0){
                mainTopics.forEach(topic=>{
                    const btn = document.createElement("button");
                    btn.className = "button";
                    btn.textContent = topic;
                    btn.onclick = () => { selectedMainTopic = topic; loadVideos(); };
                    content.appendChild(btn);
                });
                const allBtn = document.createElement("button");
                allBtn.className = "button";
                allBtn.textContent = "All Videos";
                allBtn.onclick = () => { selectedMainTopic = ""; loadVideos(); };
                content.appendChild(allBtn);
            } else {
                let videos = snapshot.docs.map(doc=>{
                    const data = doc.data();
                    return { id: doc.id, title: data.title, link: data.link, order: data.order || 999, mainTopic: data.mainTopic || "" };
                });

                if(selectedMainTopic !== null){
                    videos = videos.filter(v=>v.mainTopic === selectedMainTopic || selectedMainTopic === "");
                }

                videos.sort((a,b)=>a.order - b.order);

                if(videos.length === 0){
                    content.innerHTML = "<p>No videos found for this topic</p>";
                    return;
                }

                videos.forEach(video=>{
                    const card = document.createElement("div");
                    card.className = "file-card";
                    card.textContent = `${video.order !== 999 ? video.order + ". " : ""}${video.title}`;
                    card.onclick = () => openVideo(video.link);
                    content.appendChild(card);
                });
            }
        }
    });
}

// ---- Google Drive preview ----
function openVideo(link){
    const id = extractDriveId(link);
    if(id){
        previewIframe.src = `https://drive.google.com/file/d/${id}/preview`;
        previewContainer.style.display = "block";
    } else {
        alert("Invalid video link");
    }
}

function extractDriveId(url){
    const match = url.match(/[-\w]{25,}/);
    return match ? match[0] : "";
}

// INIT
loadSubjects();
</script>

</body>
</html>